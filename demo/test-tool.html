<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIX引擎压力测试平台</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.min.js"></script>
    <style>
        .app-container {
            padding: 20px;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .card-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .config-card, .status-card {
            flex: 1;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            border-radius: 5px;
        }
        .chart-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart {
            flex: 1;
            min-width: 45%;
            height: 300px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            padding: 15px;
            background: white;
        }
        .test-controls {
            margin: 20px 0;
            text-align: center;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #409EFF;
            margin: 10px 0;
        }
        .metric-label {
            color: #606266;
            font-size: 14px;
        }
        .report-section {
            margin-top: 30px;
        }
        .el-progress-bar {
            padding-right: 0;
        }
    </style>
</head>
<body>
    <div id="app" class="app-container">
        <div class="header">
            <h1>FIX引擎压力测试平台</h1>
            <p>基于QuickFIX/J和GCP EDMZ网络隔离环境</p>
        </div>

        <el-row :gutter="20">
            <el-col :span="16">
                <div class="card-container">
                    <el-card class="config-card">
                        <div slot="header">
                            <span>测试参数配置</span>
                        </div>
                        <el-form :model="testConfig" label-width="180px">
                            <el-form-item label="目标消息速率 (msg/s)">
                                <el-slider v-model="testConfig.msgRate" :min="100" :max="10000" :step="100" show-input></el-slider>
                            </el-form-item>
                            <el-form-item label="测试持续时间 (秒)">
                                <el-input-number v-model="testConfig.duration" :min="10" :max="3600" :step="10"></el-input-number>
                            </el-form-item>
                            <el-form-item label="FIX引擎地址">
                                <el-input v-model="testConfig.host" placeholder="fix-engine.example.com"></el-input>
                            </el-form-item>
                            <el-form-item label="端口">
                                <el-input-number v-model="testConfig.port" :min="1" :max="65535"></el-input-number>
                            </el-form-item>
                            <el-form-item label="发送者ID">
                                <el-input v-model="testConfig.senderId"></el-input>
                            </el-form-item>
                            <el-form-item label="目标ID">
                                <el-input v-model="testConfig.targetId"></el-input>
                            </el-form-item>
                            <el-form-item label="消息类型比例">
                                <div>新订单单: {{ testConfig.msgRatio.newOrder }}%</div>
                                <el-slider v-model="testConfig.msgRatio.newOrder" :min="0" :max="100"></el-slider>
                                <div>订单取消: {{ testConfig.msgRatio.orderCancel }}%</div>
                                <el-slider v-model="testConfig.msgRatio.orderCancel" :min="0" :max="100"></el-slider>
                                <div>状态请求: {{ testConfig.msgRatio.statusRequest }}%</div>
                                <el-slider v-model="testConfig.msgRatio.statusRequest" :min="0" :max="100"></el-slider>
                            </el-form-item>
                            <el-form-item label="消息大小 (字节)">
                                <el-slider v-model="testConfig.msgSize" :min="100" :max="5000" :step="100" show-input></el-slider>
                            </el-form-item>
                        </el-form>
                    </el-card>
                </div>
            </el-col>
            
            <el-col :span="8">
                <el-card class="status-card">
                    <div slot="header">
                        <span>测试状态</span>
                    </div>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">当前状态</div>
                            <div class="metric-value">{{ testStatus.status }}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">运行时间</div>
                            <div class="metric-value">{{ testStatus.elapsedTime }} 秒</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">已发送消息</div>
                            <div class="metric-value">{{ testStatus.messagesSent }}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">已接收消息</div>
                            <div class="metric-value">{{ testStatus.messagesReceived }}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">当前速率 (msg/s)</div>
                            <div class="metric-value">{{ testStatus.currentRate }}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">错误计数</div>
                            <div class="metric-value">{{ testStatus.errorCount }}</div>
                        </div>
                    </div>
                    
                    <el-progress :text-inside="true" :stroke-width="20" :percentage="testStatus.progress" style="margin: 20px 0;"></el-progress>
                    
                    <div class="test-controls">
                        <el-button type="primary" @click="startTest" :disabled="testStatus.status === '运行中'">开始测试</el-button>
                        <el-button type="danger" @click="stopTest" :disabled="testStatus.status !== '运行中'">停止测试</el-button>
                        <el-button type="success" @click="generateReport" :disabled="testStatus.status === '运行中'">生成报告</el-button>
                    </div>
                </el-card>
            </el-col>
        </el-row>

        <div class="chart-container">
            <div class="chart" id="throughputChart"></div>
            <div class="chart" id="latencyChart"></div>
            <div class="chart" id="errorChart"></div>
            <div class="chart" id="resourceChart"></div>
        </div>

        <el-card class="report-section" v-if="reportGenerated">
            <div slot="header">
                <span>压力测试分析报告</span>
            </div>
            <div>
                <h3>测试概要</h3>
                <el-table :data="reportData.summary" border style="width: 100%">
                    <el-table-column prop="metric" label="指标"></el-table-column>
                    <el-table-column prop="value" label="值"></el-table-column>
                </el-table>
                
                <h3>性能指标</h3>
                <el-table :data="reportData.performance" border style="width: 100%">
                    <el-table-column prop="metric" label="指标"></el-table-column>
                    <el-table-column prop="value" label="值"></el-table-column>
                </el-table>
                
                <h3>建议</h3>
                <el-alert
                    title="基于测试结果的分析建议"
                    type="info"
                    :description="reportData.recommendations"
                    show-icon
                    :closable="false">
                </el-alert>
                
                <div style="text-align: center; margin-top: 20px;">
                    <el-button type="primary" @click="exportReport">导出PDF报告</el-button>
                </div>
            </div>
        </el-card>
    </div>

    <script>
        new Vue({
            el: '#app',
            data() {
                return {
                    testConfig: {
                        msgRate: 1000,
                        duration: 300,
                        host: 'fix-engine-prod.edmz.example.com',
                        port: 9815,
                        senderId: 'CLIENT_TEST',
                        targetId: 'FIX_ENGINE',
                        msgRatio: {
                            newOrder: 70,
                            orderCancel: 20,
                            statusRequest: 10
                        },
                        msgSize: 500
                    },
                    testStatus: {
                        status: '就绪',
                        elapsedTime: 0,
                        messagesSent: 0,
                        messagesReceived: 0,
                        currentRate: 0,
                        errorCount: 0,
                        progress: 0
                    },
                    reportGenerated: false,
                    reportData: {
                        summary: [
                            { metric: '测试开始时间', value: '2023-10-15 14:30:22' },
                            { metric: '测试持续时间', value: '300 秒' },
                            { metric: '总发送消息数', value: '285,432' },
                            { metric: '总接收消息数', value: '284,921' },
                            { metric: '消息丢失率', value: '0.18%' }
                        ],
                        performance: [
                            { metric: '平均吞吐量', value: '951 msg/s' },
                            { metric: '峰值吞吐量', value: '1,235 msg/s' },
                            { metric: '平均延迟', value: '23.4 ms' },
                            { metric: 'P95延迟', value: '45.6 ms' },
                            { metric: 'P99延迟', value: '78.9 ms' },
                            { metric: '错误率', value: '0.05%' },
                            { metric: 'CPU使用率', value: '62.3%' },
                            { metric: '内存使用率', value: '45.8%' },
                            { metric: '网络带宽', value: '12.4 Mbps' }
                        ],
                        recommendations: '系统在1000 msg/s的目标负载下表现良好。建议：1. 监控P99延迟在更高负载下的表现；2. 考虑优化消息处理逻辑以降低CPU使用率；3. 增加更多测试客户端以测试水平扩展能力。'
                    },
                    throughputChart: null,
                    latencyChart: null,
                    errorChart: null,
                    resourceChart: null,
                    testInterval: null
                }
            },
            mounted() {
                this.initCharts();
            },
            methods: {
                initCharts() {
                    // 初始化吞吐量图表
                    this.throughputChart = echarts.init(document.getElementById('throughputChart'));
                    this.throughputChart.setOption({
                        title: { text: '消息吞吐量 (msg/s)' },
                        tooltip: { trigger: 'axis' },
                        xAxis: { type: 'category', data: [] },
                        yAxis: { type: 'value', name: 'msg/s' },
                        series: [{ 
                            name: '实际吞吐量', 
                            type: 'line', 
                            data: [],
                            smooth: true,
                            lineStyle: { width: 3 },
                            itemStyle: { color: '#5470C6' }
                        }]
                    });
                    
                    // 初始化延迟图表
                    this.latencyChart = echarts.init(document.getElementById('latencyChart'));
                    this.latencyChart.setOption({
                        title: { text: '消息延迟分布 (ms)' },
                        tooltip: { trigger: 'axis' },
                        xAxis: { type: 'category', data: [] },
                        yAxis: { type: 'value', name: '毫秒' },
                        legend: { data: ['平均延迟', 'P95延迟'] },
                        series: [
                            { 
                                name: '平均延迟', 
                                type: 'line', 
                                data: [],
                                smooth: true,
                                itemStyle: { color: '#91CC75' }
                            },
                            { 
                                name: 'P95延迟', 
                                type: 'line', 
                                data: [],
                                smooth: true,
                                itemStyle: { color: '#FAC858' }
                            }
                        ]
                    });
                    
                    // 初始化错误图表
                    this.errorChart = echarts.init(document.getElementById('errorChart'));
                    this.errorChart.setOption({
                        title: { text: '错误统计' },
                        tooltip: { trigger: 'axis' },
                        xAxis: { type: 'category', data: [] },
                        yAxis: { type: 'value', name: '错误数' },
                        series: [{ 
                            name: '错误数', 
                            type: 'bar', 
                            data: [],
                            itemStyle: { color: '#EE6666' }
                        }]
                    });
                    
                    // 初始化资源使用图表
                    this.resourceChart = echarts.init(document.getElementById('resourceChart'));
                    this.resourceChart.setOption({
                        title: { text: '资源使用率' },
                        tooltip: { trigger: 'axis' },
                        xAxis: { type: 'category', data: [] },
                        yAxis: { type: 'value', name: '百分比', max: 100 },
                        legend: { data: ['CPU使用率', '内存使用率'] },
                        series: [
                            { 
                                name: 'CPU使用率', 
                                type: 'line', 
                                data: [],
                                smooth: true,
                                itemStyle: { color: '#5470C6' }
                            },
                            { 
                                name: '内存使用率', 
                                type: 'line', 
                                data: [],
                                smooth: true,
                                itemStyle: { color: '#91CC75' }
                            }
                        ]
                    });
                    
                    // 响应窗口大小变化
                    window.addEventListener('resize', () => {
                        this.throughputChart.resize();
                        this.latencyChart.resize();
                        this.errorChart.resize();
                        this.resourceChart.resize();
                    });
                },
                startTest() {
                    this.testStatus.status = '运行中';
                    this.testStatus.elapsedTime = 0;
                    this.testStatus.messagesSent = 0;
                    this.testStatus.messagesReceived = 0;
                    this.testStatus.currentRate = 0;
                    this.testStatus.errorCount = 0;
                    this.testStatus.progress = 0;
                    this.reportGenerated = false;
                    
                    // 模拟测试数据更新
                    let time = 0;
                    this.testInterval = setInterval(() => {
                        if (time >= this.testConfig.duration) {
                            this.stopTest();
                            return;
                        }
                        
                        time += 1;
                        this.testStatus.elapsedTime = time;
                        this.testStatus.progress = Math.min(100, (time / this.testConfig.duration) * 100);
                        
                        // 模拟消息发送和接收
                        const baseMessages = Math.floor(this.testConfig.msgRate / 10);
                        const randomFactor = 0.8 + Math.random() * 0.4;
                        const messagesThisSecond = Math.floor(baseMessages * randomFactor);
                        
                        this.testStatus.messagesSent += messagesThisSecond;
                        this.testStatus.messagesReceived += Math.floor(messagesThisSecond * (0.995 + Math.random() * 0.01));
                        this.testStatus.currentRate = messagesThisSecond;
                        
                        if (Math.random() > 0.9) {
                            this.testStatus.errorCount += Math.floor(Math.random() * 3);
                        }
                        
                        // 更新图表数据
                        this.updateCharts(time, messagesThisSecond);
                    }, 1000);
                },
                updateCharts(time, messagesThisSecond) {
                    // 更新吞吐量图表
                    const throughputOption = this.throughputChart.getOption();
                    throughputOption.xAxis[0].data.push(time);
                    throughputOption.series[0].data.push(messagesThisSecond);
                    this.throughputChart.setOption(throughputOption);
                    
                    // 更新延迟图表
                    const avgLatency = 20 + Math.random() * 15;
                    const p95Latency = avgLatency * (1.8 + Math.random() * 0.4);
                    
                    const latencyOption = this.latencyChart.getOption();
                    latencyOption.xAxis[0].data.push(time);
                    latencyOption.series[0].data.push(avgLatency.toFixed(1));
                    latencyOption.series[1].data.push(p95Latency.toFixed(1));
                    this.latencyChart.setOption(latencyOption);
                    
                    // 更新错误图表
                    const errorCount = Math.random() > 0.7 ? Math.floor(Math.random() * 5) : 0;
                    const errorOption = this.errorChart.getOption();
                    errorOption.xAxis[0].data.push(time);
                    errorOption.series[0].data.push(errorCount);
                    this.errorChart.setOption(errorOption);
                    
                    // 更新资源图表
                    const cpuUsage = 40 + Math.random() * 40;
                    const memoryUsage = 30 + Math.random() * 30;
                    
                    const resourceOption = this.resourceChart.getOption();
                    resourceOption.xAxis[0].data.push(time);
                    resourceOption.series[0].data.push(cpuUsage.toFixed(1));
                    resourceOption.series[1].data.push(memoryUsage.toFixed(1));
                    this.resourceChart.setOption(resourceOption);
                },
                stopTest() {
                    if (this.testInterval) {
                        clearInterval(this.testInterval);
                        this.testInterval = null;
                    }
                    this.testStatus.status = '已完成';
                },
                generateReport() {
                    // 模拟生成报告数据
                    this.reportGenerated = true;
                    
                    // 滚动到报告部分
                    setTimeout(() => {
                        const reportSection = document.querySelector('.report-section');
                        if (reportSection) {
                            reportSection.scrollIntoView({ behavior: 'smooth' });
                        }
                    }, 100);
                },
                exportReport() {
                    this.$message.success('报告导出功能将在实际实现中完成');
                }
            },
            beforeDestroy() {
                if (this.testInterval) {
                    clearInterval(this.testInterval);
                }
            }
        });
    </script>
</body>
</html>